<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jaagro.report.biz.mapper.tms.WaybillMapperExt">
    <select id="listSettleManageWaybillFee" resultType="com.jaagro.report.api.dto.settlemanage.ReturnWaybillFeeDto"
            parameterType="com.jaagro.report.api.dto.settlemanage.WaybillFeeCriteria">
        select wb.id waybillId,wb.load_site_id loadSiteId,wb.truck_id truckId,wb.network_id netWorkId,os.customer_id
        customerId, os.goods_type goodsType from waybill wb
        inner join orders os on (wb.order_id=os.id)
        <where>
            wb.enabled = 1 and wb.receipt_status=2 and wb.waybill_status = '已完成'
            <if test="waybillId!=null">
                and wb.id=#{waybillId}
            </if>
            <if test="goodsType!=null">
                and os.goods_type=#{goodsType}
            </if>
            <if test="truckIds!=null">
                and wb.truck_id in
                <foreach collection="truckIds" open="(" separator="," close=")" item="truckId">
                    ${truckId}
                </foreach>
            </if>
            <if test="customerIds!=null">
                and os.customer_id in
                <foreach collection="customerIds" open="(" separator="," close=")" item="customerId">
                    ${customerId}
                </foreach>
            </if>
            <if test="finishTime!=null">
                and date_format(wb.modify_time, '%Y-%m')=#{finishTime}
            </if>
            <if test="driverId!=null">
                and wb.driver_id=#{driverId}
            </if>
            <if test="startDate != null">
                and wb.modify_time &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                and wb.modify_time &lt; #{endDate}
            </if>
            <if test="networkIds!=null and networkIds.size > 0">
                and os.customer_id in
                <foreach collection="networkIds" open="(" separator="," close=")" item="networkId">
                    ${networkId}
                </foreach>
            </if>
        </where>
    </select>
    <select id="selectByParams" resultType="java.util.Map">
        SELECT
            count(1) AS total_waybill,
            SUM(CASE WHEN wg.unload_quantity IS NULL THEN 0 ELSE wg.unload_quantity END) AS total_quantity,
            SUM(CASE WHEN wg.unload_weight IS NULL THEN 0 ELSE wg.unload_weight END) AS total_weight,
            SUM(wcf.money) AS total_freight
        FROM
            waybill w
        INNER JOIN orders o on w.order_id = o.id
        LEFT JOIN waybill_customer_fee wcf ON wcf.enabled = 1 AND w.id = wcf.waybill_id AND wcf.anomaly_id is NULL AND wcf.earning_type = 1
        LEFT JOIN waybill_goods wg on w.id = wg.waybill_id
        WHERE
            w.modify_time BETWEEN #{start}
        AND #{end}
        AND w.enabled = 1
        AND wg.enabled = 1
        AND w.waybill_status = '已完成'
        AND w.receipt_status=2
        AND o.customer_id = #{customerId}
    </select>
    <select id="listWaybillIdByCriteria" resultType="java.lang.Integer"
            parameterType="com.jaagro.report.api.dto.settlemanage.DriverFeeCriteria">
        SELECT DISTINCT
        wb.id
        FROM
          waybill wb
        WHERE
        wb.modify_time BETWEEN #{beginDate} and #{endDate} and wb.receipt_status=2 and wb.driver_id=#{driverId}
    </select>
</mapper>